<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SpatX - Spatial Transcriptomics Platform</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      /* Your exact CSS variables and styling */
      :root {
        --primary-gradient: linear-gradient(135deg, #8b5cf6, #7c3aed);
        --secondary-gradient: linear-gradient(135deg, #f8fafc, #f1f5f9);
        --shadow-soft: 0 1px 3px 0 rgba(139, 92, 246, 0.1),
          0 1px 2px 0 rgba(139, 92, 246, 0.06);
        --shadow-medium: 0 4px 6px -1px rgba(139, 92, 246, 0.1),
          0 2px 4px -1px rgba(139, 92, 246, 0.06);
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .bg-primary-gradient {
        background: var(--primary-gradient);
      }
      .bg-secondary-gradient {
        background: var(--secondary-gradient);
      }
      .shadow-soft {
        box-shadow: var(--shadow-soft);
      }
      .shadow-medium {
        box-shadow: var(--shadow-medium);
      }
      .transition-smooth {
        transition: var(--transition-smooth);
      }
      .bg-clip-text {
        -webkit-background-clip: text;
        background-clip: text;
      }
      .text-transparent {
        color: transparent;
      }

      /* Page system */
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }

      /* Custom Animations */
      @keyframes blob {
        0%, 100% {
          transform: translate(0, 0) scale(1);
        }
        25% {
          transform: translate(20px, -50px) scale(1.1);
        }
        50% {
          transform: translate(-20px, 20px) scale(0.9);
        }
        75% {
          transform: translate(50px, 50px) scale(1.05);
        }
      }

      .animate-blob {
        animation: blob 7s infinite;
      }

      .animation-delay-2000 {
        animation-delay: 2s;
      }

      .animation-delay-4000 {
        animation-delay: 4s;
      }

      @keyframes fade-in {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slide-up {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fade-in 0.8s ease-out forwards;
      }

      .animate-fade-in-delayed {
        animation: fade-in 0.8s ease-out forwards;
        opacity: 0;
      }

      .animate-slide-up {
        animation: slide-up 0.8s ease-out forwards;
      }

      /* Button styles */
      .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: var(--transition-smooth);
        cursor: pointer;
        border: none;
      }

      .button-primary {
        background: var(--primary-gradient);
        color: white;
      }

      .button-primary:hover {
        opacity: 0.9;
      }
      .button-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .button-secondary {
        background: white;
        color: #374151;
        border: 1px solid #d1d5db;
      }

      .button-secondary:hover {
        background: #f9fafb;
      }

      .input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        transition: var(--transition-smooth);
      }

      .input:focus {
        outline: none;
        border-color: #8b5cf6;
        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
      }

      .card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        box-shadow: var(--shadow-soft);
        transition: var(--transition-smooth);
      }

      .card:hover {
        box-shadow: var(--shadow-medium);
      }

      /* Gene button styles */
      .gene-button {
        transition: all 0.2s ease;
      }

      .gene-button:hover {
        transform: translateY(-2px);
        background: #f3f4f6;
      }

      .gene-button.selected {
        background: #8b5cf6;
        color: white;
      }

      /* Toast styles */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
      }

      .toast.show {
        transform: translateX(0);
      }
      .toast.success {
        background: #10b981;
      }
      .toast.error {
        background: #ef4444;
      }
      .toast.info {
        background: #3b82f6;
      }
    </style>
  </head>

  <body class="bg-secondary-gradient min-h-screen">
    <!-- Page Container -->
    <div id="app">
      <!-- Login Page -->
      <div id="login-page" class="page active">
        <div
          class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4"
        >
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div class="text-center mb-8">
              <div
                class="w-16 h-16 bg-primary-gradient rounded-2xl flex items-center justify-center mx-auto mb-4"
              >
                <i class="fas fa-microscope text-2xl text-white"></i>
              </div>
              <h1 class="text-3xl font-bold text-gray-900">Welcome Back</h1>
              <p class="text-gray-600 mt-2">Sign in to your SpatX account</p>
            </div>

            <form id="login-form" class="space-y-6">
              <div
                id="login-error"
                class="hidden bg-red-50 border border-red-200 rounded-lg p-3"
              >
                <p class="text-red-800 text-sm"></p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Username</label
                >
                <input
                  type="text"
                  id="login-username"
                  required
                  class="input"
                  placeholder="Enter your username"
                  value=""
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Password</label
                >
                <input
                  type="password"
                  id="login-password"
                  required
                  class="input"
                  placeholder="Enter your password"
                  value=""
                />
              </div>

              <button
                type="submit"
                id="login-btn"
                class="button button-primary w-full"
              >
                Sign In
              </button>

              <div class="text-center">
                <p class="text-sm text-gray-600">
                  Don't have an account?
                  <button
                    type="button"
                    onclick="showRegisterForm()"
                    class="text-purple-600 hover:underline font-medium ml-1"
                  >
                    Sign up here
                  </button>
                </p>
              </div>
            </form>

            <!-- Registration Form (Hidden by default) -->
            <form id="register-form" class="space-y-6 hidden">
              <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Create Account</h2>
                <p class="text-gray-600 mt-2">
                  Join SpatX with 10 free credits!
                </p>
              </div>

              <div
                id="register-error"
                class="hidden bg-red-50 border border-red-200 rounded-lg p-3"
              >
                <p class="text-red-800 text-sm"></p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Username</label
                >
                <input
                  type="text"
                  id="register-username"
                  required
                  class="input"
                  placeholder="Choose a username"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Email</label
                >
                <input
                  type="email"
                  id="register-email"
                  required
                  class="input"
                  placeholder="Enter your email"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Password</label
                >
                <input
                  type="password"
                  id="register-password"
                  required
                  class="input"
                  placeholder="Create a password (min 6 characters)"
                  minlength="6"
                />
              </div>

              <button
                type="submit"
                id="register-btn"
                class="button button-primary w-full"
              >
                Create Account
              </button>

              <div class="text-center">
                <p class="text-sm text-gray-600">
                  Already have an account?
                  <button
                    type="button"
                    onclick="showLoginForm()"
                    class="text-purple-600 hover:underline font-medium ml-1"
                  >
                    Sign in here
                  </button>
                </p>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Dashboard Page -->
      <div id="dashboard-page" class="page">
        <!-- Header -->
        <header class="bg-white shadow-lg border-b sticky top-0 z-40">
          <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <div
                  class="w-12 h-12 bg-primary-gradient rounded-2xl flex items-center justify-center shadow-medium"
                >
                  <i class="fas fa-microscope text-2xl text-white"></i>
                </div>
                <div>
                  <h1
                    class="text-3xl font-bold bg-primary-gradient bg-clip-text text-transparent"
                  >
                    SpatX Platform
                  </h1>
                  <p class="text-sm text-gray-600">
                    Spatial transcriptomics analysis platform
                  </p>
                </div>
              </div>

              <div class="flex items-center space-x-4">
                <div
                  class="flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-purple-50 to-blue-50 rounded-full border border-purple-200"
                >
                  <svg
                    class="w-4 h-4 text-purple-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                  <span
                    id="dashboard-credits"
                    class="text-sm font-bold text-purple-700"
                    >0</span
                  >
                  <span class="text-xs text-purple-600">credits</span>
                </div>
                <div class="text-sm text-gray-600">
                  Welcome, <span id="user-name">Demo User</span>
                </div>
                <button
                  onclick="logout()"
                  class="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-smooth"
                >
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </button>
              </div>
            </div>
          </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-8">
          <!-- Hero Section -->
          <section class="relative overflow-hidden py-20 px-4">
            <!-- Animated Background Elements -->
            <div class="absolute inset-0 overflow-hidden pointer-events-none">
              <div class="absolute -top-40 -right-40 w-80 h-80 bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
              <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
              <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-80 h-80 bg-pink-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
            </div>

            <div class="max-w-6xl mx-auto relative z-10">
              <!-- Tagline Badge -->
              <div class="flex justify-center mb-8 animate-fade-in">
                <div class="inline-flex items-center gap-2 px-4 py-2 bg-white/80 backdrop-blur-sm rounded-full shadow-soft border border-purple-100">
                  <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-purple-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-purple-500"></span>
                  </span>
                  <span class="text-sm font-medium text-gray-700">AI-Powered Spatial Transcriptomics</span>
                </div>
              </div>

              <!-- Main Heading -->
              <h1 class="text-6xl md:text-7xl font-extrabold mb-6 animate-slide-up">
                <span class="block text-gray-900 leading-tight">Decode Tissue</span>
                <span class="block bg-gradient-to-r from-purple-600 via-pink-500 to-blue-500 bg-clip-text text-transparent leading-tight">
                  At Cellular Resolution
                </span>
              </h1>

              <!-- Subheading -->
              <p class="text-xl md:text-2xl text-gray-600 mb-12 max-w-3xl mx-auto leading-relaxed animate-fade-in-delayed" style="animation-delay: 0.2s">
                Transform histology images into spatial gene expression maps using
                <span class="font-semibold text-purple-600">state-of-the-art vision transformers</span>. 
                Train custom models and visualize patterns with clinical precision.
              </p>

              <!-- CTA Buttons -->
              <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-16 animate-fade-in-delayed" style="animation-delay: 0.4s">
                <button onclick="showPage('training')" class="group relative px-8 py-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                  <span class="relative z-10 flex items-center gap-2">
                    <i class="fas fa-rocket"></i>
                    Start Training
                    <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                  </span>
                  <div class="absolute inset-0 bg-gradient-to-r from-purple-700 to-blue-700 rounded-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </button>
                <button onclick="showPage('prediction')" class="px-8 py-4 bg-white text-gray-700 font-semibold rounded-xl border-2 border-gray-200 hover:border-purple-300 hover:bg-purple-50 transform hover:-translate-y-1 transition-all duration-300 shadow-md hover:shadow-xl">
                  <span class="flex items-center gap-2">
                    <i class="fas fa-chart-bar"></i>
                    Make Predictions
                  </span>
                </button>
              </div>

              <!-- Stats Row -->
              <div class="grid grid-cols-3 gap-8 max-w-3xl mx-auto animate-fade-in-delayed" style="animation-delay: 0.6s">
                <div class="text-center">
                  <div class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-500 bg-clip-text text-transparent">50+</div>
                  <div class="text-sm text-gray-600 mt-1">Breast Cancer Genes</div>
                </div>
                <div class="text-center border-x border-gray-200">
                  <div class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-500 bg-clip-text text-transparent">10x</div>
                  <div class="text-sm text-gray-600 mt-1">Faster Training</div>
                </div>
                <div class="text-center">
                  <div class="text-3xl font-bold bg-gradient-to-r from-pink-600 to-purple-500 bg-clip-text text-transparent">Real-time</div>
                  <div class="text-sm text-gray-600 mt-1">Visualization</div>
                </div>
              </div>
            </div>
          </section>

          <!-- Workflow Section -->
          <section class="pb-20">
            <!-- Section Header -->
            <div class="text-center mb-12">
              <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                Streamlined Two-Phase Workflow
              </h2>
              <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                From model training to spatial predictions in minutes, not months
              </p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 max-w-6xl mx-auto">
              <!-- Training Phase Card -->
              <div
                class="group relative bg-white rounded-2xl border-2 border-gray-100 hover:border-transparent hover:shadow-2xl transition-all duration-500 cursor-pointer overflow-hidden"
                onclick="showPage('training')"
              >
                <!-- Gradient Border Effect -->
                <div class="absolute inset-0 bg-gradient-to-br from-purple-500 via-pink-500 to-blue-500 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-2xl"></div>
                <div class="absolute inset-0.5 bg-white rounded-2xl"></div>
                
                <!-- Card Content -->
                <div class="relative p-8">
                  <!-- Icon -->
                  <div class="relative mb-6">
                    <div class="absolute inset-0 bg-gradient-to-br from-purple-400 to-pink-400 rounded-2xl blur-xl opacity-50 group-hover:opacity-75 transition-opacity"></div>
                    <div class="relative w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center transform group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300">
                      <i class="fas fa-flask text-white text-2xl"></i>
                    </div>
                  </div>

                  <!-- Title & Badge -->
                  <div class="mb-4">
                    <div class="inline-block px-3 py-1 bg-purple-100 text-purple-700 text-xs font-semibold rounded-full mb-3">
                      PHASE 1
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">
                      Model Training
                    </h3>
                    <p class="text-gray-600 leading-relaxed">
                      Fine-tune pre-trained CIT transformers on your spatial transcriptomics data with custom gene panels
                    </p>
                  </div>

                  <!-- Feature List -->
                  <div class="space-y-3 mb-8">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 bg-purple-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-check text-purple-600 text-xs"></i>
                      </div>
                      <span class="text-sm text-gray-700">CSV + tissue image upload</span>
                    </div>
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 bg-purple-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-check text-purple-600 text-xs"></i>
                      </div>
                      <span class="text-sm text-gray-700">Custom gene panel selection</span>
                    </div>
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 bg-purple-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-check text-purple-600 text-xs"></i>
                      </div>
                      <span class="text-sm text-gray-700">Real-time training metrics</span>
                    </div>
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 bg-purple-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-check text-purple-600 text-xs"></i>
                      </div>
                      <span class="text-sm text-gray-700">Automatic model versioning</span>
                    </div>
                  </div>

                  <!-- CTA Button -->
                  <button class="w-full px-6 py-3.5 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-xl shadow-lg group-hover:shadow-xl transform group-hover:scale-[1.02] transition-all duration-300">
                    <span class="flex items-center justify-center gap-2">
                      Start Training
                      <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </span>
                  </button>
                </div>
              </div>

              <!-- Prediction Phase Card -->
              <div
                class="group relative bg-white rounded-2xl border-2 border-gray-100 hover:border-transparent hover:shadow-2xl transition-all duration-500 cursor-pointer overflow-hidden"
                onclick="showPage('prediction')"
              >
                <!-- Gradient Border Effect -->
                <div class="absolute inset-0 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 opacity-0 group-hover:opacity-100 transition-opacity duration-500 rounded-2xl"></div>
                <div class="absolute inset-0.5 bg-white rounded-2xl"></div>
                
                <!-- Card Content -->
                <div class="relative p-8">
                  <!-- Icon -->
                  <div class="relative mb-6">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-400 to-purple-400 rounded-2xl blur-xl opacity-50 group-hover:opacity-75 transition-opacity"></div>
                    <div class="relative w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-2xl flex items-center justify-center transform group-hover:scale-110 group-hover:rotate-3 transition-transform duration-300">
                      <i class="fas fa-chart-area text-white text-2xl"></i>
                    </div>
                  </div>

                  <!-- Title & Badge -->
                  <div class="mb-4">
                    <div class="inline-block px-3 py-1 bg-blue-100 text-blue-700 text-xs font-semibold rounded-full mb-3">
                      PHASE 2
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">
                      Gene Prediction
                    </h3>
                    <p class="text-gray-600 leading-relaxed">
                      Generate high-resolution spatial gene expression maps from new tissue samples
                    </p>
                  </div>

                  <!-- Feature List -->
                  <div class="space-y-3 mb-8">
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-check text-blue-600 text-xs"></i>
                      </div>
                      <span class="text-sm text-gray-700">Upload new tissue images</span>
                    </div>
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-check text-blue-600 text-xs"></i>
                      </div>
                      <span class="text-sm text-gray-700">Multi-gene expression overlays</span>
                    </div>
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-check text-blue-600 text-xs"></i>
                      </div>
                      <span class="text-sm text-gray-700">Interactive heatmap & contours</span>
                    </div>
                    <div class="flex items-start gap-3">
                      <div class="flex-shrink-0 w-5 h-5 bg-blue-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-check text-blue-600 text-xs"></i>
                      </div>
                      <span class="text-sm text-gray-700">Export-ready visualizations</span>
                    </div>
                  </div>

                  <!-- CTA Button -->
                  <button class="w-full px-6 py-3.5 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-xl shadow-lg group-hover:shadow-xl transform group-hover:scale-[1.02] transition-all duration-300">
                    <span class="flex items-center justify-center gap-2">
                      Make Predictions
                      <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </section>

          <!-- Visual Workflow Section -->
          <section class="pb-20">
            <div class="max-w-6xl mx-auto">
              <!-- Section Header -->
              <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                  See It In Action
                </h2>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                  From raw histology to spatial gene expression maps
                </p>
              </div>

              <!-- Workflow Diagram -->
              <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 border border-gray-100">
                <img 
                  src="untitled.png" 
                  alt="SpatX Workflow: From tissue input to expression visualization" 
                  class="w-full h-auto rounded-xl"
                />
                
                <!-- Caption Grid Below Image -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-8">
                  <!-- Input -->
                  <div class="text-center md:col-span-4 pb-4 border-b border-gray-200">
                    <div class="inline-flex items-center gap-2 px-4 py-2 bg-purple-100 rounded-full mb-3">
                      <i class="fas fa-arrow-down text-purple-600"></i>
                      <span class="text-sm font-semibold text-purple-700">INPUT</span>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-1">H&E Stained Tissue</h3>
                    <p class="text-sm text-gray-600">Standard histology microscopy image</p>
                  </div>

                  <!-- Output 1 -->
                  <div class="text-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mx-auto mb-3">
                      <i class="fas fa-th text-white text-xl"></i>
                    </div>
                    <h3 class="text-base font-bold text-gray-900 mb-1">Grid Predictions</h3>
                    <p class="text-xs text-gray-600">Discrete point-wise expression values</p>
                  </div>

                  <!-- Output 2 -->
                  <div class="text-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3">
                      <i class="fas fa-fire text-white text-xl"></i>
                    </div>
                    <h3 class="text-base font-bold text-gray-900 mb-1">Expression Heatmap</h3>
                    <p class="text-xs text-gray-600">Continuous spatial distribution map</p>
                  </div>

                  <!-- Output 3 -->
                  <div class="text-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-purple-500 rounded-xl flex items-center justify-center mx-auto mb-3">
                      <i class="fas fa-layer-group text-white text-xl"></i>
                    </div>
                    <h3 class="text-base font-bold text-gray-900 mb-1">Contour Overlay</h3>
                    <p class="text-xs text-gray-600">Multi-level isocontours on tissue</p>
                  </div>

                  <!-- Output 4 -->
                  <div class="text-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-500 rounded-xl flex items-center justify-center mx-auto mb-3">
                      <i class="fas fa-chart-area text-white text-xl"></i>
                    </div>
                    <h3 class="text-base font-bold text-gray-900 mb-1">Clinical Visualization</h3>
                    <p class="text-xs text-gray-600">Export-ready spatial analysis</p>
                  </div>
                </div>

                <!-- Technical Details -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                  <div class="flex flex-wrap justify-center gap-4 text-xs text-gray-500">
                    <div class="flex items-center gap-2">
                      <i class="fas fa-check-circle text-purple-500"></i>
                      <span>Cubic Interpolation</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i class="fas fa-check-circle text-purple-500"></i>
                      <span>Multi-Gene Analysis</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i class="fas fa-check-circle text-purple-500"></i>
                      <span>High-Resolution Output</span>
                    </div>
                    <div class="flex items-center gap-2">
                      <i class="fas fa-check-circle text-purple-500"></i>
                      <span>Clinical-Grade Accuracy</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </main>
      </div>

      <!-- Prediction Upload Page -->
      <div id="prediction-page" class="page">
        <header class="bg-white shadow-lg border-b sticky top-0 z-40">
          <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <button
                  onclick="showPage('dashboard')"
                  class="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-smooth"
                >
                  <i class="fas fa-arrow-left"></i>
                  <span>Back</span>
                </button>
                <div
                  class="w-8 h-8 bg-primary-gradient rounded-lg flex items-center justify-center"
                >
                  <i class="fas fa-upload text-white"></i>
                </div>
                <div>
                  <h1 class="text-2xl font-bold text-gray-900">
                    Prediction Data Upload
                  </h1>
                  <p class="text-sm text-gray-600">
                    Upload tissue image for gene expression prediction
                  </p>
                </div>
              </div>

              <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-600">
                  Welcome, <span id="prediction-user-name">Demo User</span>
                </div>
                <button
                  onclick="logout()"
                  class="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-smooth"
                >
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </button>
              </div>
            </div>
          </div>
        </header>

        <main class="container mx-auto px-6 py-8">
          <!-- Progress Indicator -->
          <div
            class="flex items-center gap-4 p-4 bg-white rounded-lg shadow-soft mb-8"
          >
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-primary-gradient text-white rounded-full flex items-center justify-center font-bold"
              >
                1
              </div>
              <span class="font-medium text-purple-600">Upload Image</span>
            </div>
            <i class="fas fa-arrow-right w-4 h-4 text-gray-400"></i>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center font-bold"
              >
                2
              </div>
              <span class="text-gray-600">Select Genes</span>
            </div>
            <i class="fas fa-arrow-right w-4 h-4 text-gray-400"></i>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center font-bold"
              >
                3
              </div>
              <span class="text-gray-600">View Heatmap</span>
            </div>
          </div>

          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-3xl shadow-xl p-8">
              <div class="flex items-center mb-8">
                <div
                  class="w-8 h-8 bg-primary-gradient rounded-lg flex items-center justify-center mr-3"
                >
                  <i class="fas fa-image text-white"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">
                  Upload Histology Image
                </h3>
              </div>

              <!-- File Upload Area -->
              <div
                id="prediction-upload-area"
                class="border-3 border-dashed border-gray-300 rounded-2xl p-8 text-center cursor-pointer transition-all duration-300 hover:border-purple-400 hover:bg-purple-50 mb-8"
              >
                <div id="prediction-upload-content">
                  <i
                    class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"
                  ></i>
                  <p class="text-lg font-semibold text-gray-700 mb-2">
                    Drop your histology image here
                  </p>
                  <p class="text-sm text-gray-500 mb-4">or click to browse</p>
                  <div
                    class="flex justify-center space-x-2 text-xs text-gray-400"
                  >
                    <span class="bg-gray-100 px-2 py-1 rounded">PNG</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">JPG</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">TIF</span>
                    <span class="bg-gray-100 px-2 py-1 rounded">TIFF</span>
                  </div>
                </div>
                <input
                  type="file"
                  id="prediction-file-input"
                  accept=".png,.jpg,.jpeg,.tif,.tiff"
                  class="hidden"
                />
              </div>

              <!-- Selected File Display -->
              <div
                id="prediction-file-display"
                class="hidden bg-gray-50 p-4 rounded-lg border border-gray-200 mb-8"
              >
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-3">
                    <i class="fas fa-file-image text-purple-600 text-xl"></i>
                    <div>
                      <p
                        id="prediction-file-name"
                        class="font-medium text-gray-900"
                      ></p>
                      <p
                        id="prediction-file-size"
                        class="text-sm text-gray-500"
                      ></p>
                    </div>
                  </div>
                  <button
                    onclick="clearPredictionFile()"
                    class="text-red-500 hover:text-red-700"
                  >
                    <i class="fas fa-times-circle text-xl"></i>
                  </button>
                </div>
              </div>

              <!-- Model Selection -->
              <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-800 mb-4">
                  <i class="fas fa-brain mr-2 text-purple-500"></i>Model Selection
                </label>
                <p class="text-gray-600 text-sm mb-4">
                  Choose which model to use for predictions.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <label
                    class="flex items-center space-x-3 p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 transition-smooth"
                  >
                    <input
                      type="radio"
                      name="model-select"
                      value="original"
                      class="form-radio text-purple-600"
                      checked
                      onchange="handleModelSelection()"
                    />
                    <div>
                      <div class="font-medium">Original 50-Gene Model</div>
                      <div class="text-sm text-gray-500">
                        Pre-trained baseline model
                      </div>
                    </div>
                  </label>
                  <label
                    id="user-model-option"
                    class="hidden flex items-center space-x-3 p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 transition-smooth"
                  >
                    <input
                      type="radio"
                      name="model-select"
                      value="user"
                      class="form-radio text-purple-600"
                      onchange="handleModelSelection()"
                    />
                    <div>
                      <div class="font-medium flex items-center gap-2">
                        <span>My Trained Model</span>
                        <i class="fas fa-star text-yellow-500 text-xs"></i>
                      </div>
                      <div class="text-sm text-gray-500">
                        Fine-tuned on your data
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Prediction Density -->
              <div class="mb-8">
                <label class="block text-lg font-semibold text-gray-800 mb-4">
                  <i class="fas fa-th-large mr-2 text-green-500"></i>Prediction
                  Density
                </label>
                <p class="text-gray-600 text-sm mb-4">
                  Choose how dense you want the predictions to be. Higher
                  density means more points and longer processing time.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <label
                    class="flex items-center space-x-3 p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 transition-smooth"
                  >
                    <input
                      type="radio"
                      name="density"
                      value="low"
                      class="form-radio text-purple-600"
                      checked
                    />
                    <div>
                      <div class="font-medium">Low Density</div>
                      <div class="text-sm text-gray-500">
                        ~50 points, faster
                      </div>
                    </div>
                  </label>
                  <label
                    class="flex items-center space-x-3 p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 transition-smooth"
                  >
                    <input
                      type="radio"
                      name="density"
                      value="medium"
                      class="form-radio text-purple-600"
                    />
                    <div>
                      <div class="font-medium">Medium Density</div>
                      <div class="text-sm text-gray-500">
                        ~150 points, balanced
                      </div>
                    </div>
                  </label>
                  <label
                    class="flex items-center space-x-3 p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-purple-300 transition-smooth"
                  >
                    <input
                      type="radio"
                      name="density"
                      value="high"
                      class="form-radio text-purple-600"
                    />
                    <div>
                      <div class="font-medium">High Density</div>
                      <div class="text-sm text-gray-500">
                        ~300 points, slower
                      </div>
                    </div>
                  </label>
                  <label
                    class="flex items-center space-x-3 p-4 border-2 border-purple-300 bg-purple-50 rounded-lg cursor-pointer hover:border-purple-400 transition-smooth"
                  >
                    <input
                      type="radio"
                      name="density"
                      value="full"
                      class="form-radio text-purple-600"
                    />
                    <div>
                      <div class="font-medium flex items-center">
                        <span>Full Heatmap</span>
                        <span class="ml-2 px-2 py-0.5 bg-purple-600 text-white text-xs rounded-full">NEW</span>
                      </div>
                      <div class="text-sm text-gray-600">
                        All points, comprehensive view
                      </div>
                    </div>
                  </label>
                </div>
              </div>

              <div class="flex justify-between">
                <button
                  onclick="showPage('dashboard')"
                  class="button button-secondary"
                >
                  <i class="fas fa-arrow-left mr-2"></i>Back to Home
                </button>
                <button
                  id="prediction-proceed-btn"
                  disabled
                  class="button button-primary opacity-50"
                >
                  Proceed to Gene Selection
                  <i class="fas fa-arrow-right ml-2"></i>
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Gene Selection Page -->
      <div id="gene-selection-page" class="page">
        <header class="bg-white shadow-lg border-b sticky top-0 z-40">
          <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <button
                  onclick="showPage('prediction')"
                  class="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-smooth"
                >
                  <i class="fas fa-arrow-left"></i>
                  <span>Back</span>
                </button>
                <div
                  class="w-8 h-8 bg-primary-gradient rounded-lg flex items-center justify-center"
                >
                  <i class="fas fa-dna text-white"></i>
                </div>
                <div>
                  <h1 class="text-2xl font-bold text-gray-900">
                    Gene Selection
                  </h1>
                  <p class="text-sm text-gray-600">
                    Choose genes for expression prediction
                  </p>
                </div>
              </div>

              <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-600">
                  Welcome, <span id="gene-user-name">Demo User</span>
                </div>
                <button
                  onclick="logout()"
                  class="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-smooth"
                >
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </button>
              </div>
            </div>
          </div>
        </header>

        <main class="container mx-auto px-6 py-8">
          <!-- Progress Indicator -->
          <div
            class="flex items-center gap-4 p-4 bg-white rounded-lg shadow-soft mb-8"
          >
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center"
              >
                <i class="fas fa-check text-sm"></i>
              </div>
              <span class="text-green-600">Upload Image</span>
            </div>
            <i class="fas fa-arrow-right w-4 h-4 text-gray-400"></i>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-primary-gradient text-white rounded-full flex items-center justify-center font-bold"
              >
                2
              </div>
              <span class="font-medium text-purple-600">Select Genes</span>
            </div>
            <i class="fas fa-arrow-right w-4 h-4 text-gray-400"></i>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center font-bold"
              >
                3
              </div>
              <span class="text-gray-600">View Heatmap</span>
            </div>
          </div>

          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-3xl shadow-xl p-8">
              <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                  <h3
                    class="text-2xl font-bold text-gray-900 flex items-center gap-2"
                  >
                    <i class="fas fa-dna text-purple-600"></i>
                    Gene Selection Panel
                  </h3>
                  <p class="text-gray-600">
                    Select genes from the 50-gene working panel.
                    <span id="selected-count">0</span> selected.
                  </p>
                </div>
                <div class="flex gap-2">
                  <button
                    id="select-all-genes-btn"
                    class="button button-secondary"
                  >
                    Select All (50)
                  </button>
                  <button
                    id="clear-all-genes-btn"
                    class="button button-secondary"
                  >
                    Clear All
                  </button>
                </div>
              </div>

              <!-- Search -->
              <div class="mb-6">
                <div class="relative">
                  <i
                    class="fas fa-search absolute left-3 top-3 text-gray-400"
                  ></i>
                  <input
                    type="text"
                    id="gene-search"
                    placeholder="Search genes..."
                    class="input pl-10"
                  />
                </div>
              </div>

              <!-- Selected Genes Display -->
              <div
                id="selected-genes-display"
                class="hidden p-3 bg-purple-50 border border-purple-200 rounded-lg mb-6"
              >
                <h4 class="text-sm font-medium mb-2 text-purple-800">
                  Selected Genes:
                </h4>
                <div
                  id="selected-genes-list"
                  class="flex flex-wrap gap-1"
                ></div>
              </div>

              <!-- Gene Categories -->
              <div class="space-y-4 mb-6">
                <h4 class="text-lg font-semibold flex items-center gap-2">
                  <i class="fas fa-ribbon text-pink-500"></i>
                  Breast Cancer Panel - Functional Categories
                  <span class="text-sm text-gray-500">(50 genes, 13 categories)</span>
                </h4>
                
                <!-- Category-based gene selection -->
                <div id="gene-categories-container" class="space-y-3">
                  <!-- Categories will be populated by JavaScript -->
                </div>
              </div>

              <div class="flex justify-between">
                <button
                  onclick="showPage('prediction')"
                  class="button button-secondary"
                >
                  <i class="fas fa-arrow-left mr-2"></i>Back to Upload
                </button>
                <button
                  id="generate-predictions-btn"
                  disabled
                  class="button button-primary opacity-50"
                  onclick="runPrediction()"
                >
                  <span id="generate-btn-text">Generate Predictions</span>
                  <i class="fas fa-chart-area ml-2"></i>
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Heatmap Results Page -->
      <div id="heatmap-page" class="page">
        <header class="bg-white shadow-lg border-b sticky top-0 z-40">
          <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <button
                  onclick="showPage('gene-selection')"
                  class="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-smooth"
                >
                  <i class="fas fa-arrow-left"></i>
                  <span>Back</span>
                </button>
                <div
                  class="w-8 h-8 bg-primary-gradient rounded-lg flex items-center justify-center"
                >
                  <i class="fas fa-chart-area text-white"></i>
                </div>
                <div>
                  <h1 class="text-2xl font-bold text-gray-900">
                    Heatmap Results
                  </h1>
                  <p class="text-sm text-gray-600">
                    View spatial gene expression heatmaps
                  </p>
                </div>
              </div>

              <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-600">
                  Welcome, <span id="heatmap-user-name">Demo User</span>
                </div>
                <button
                  onclick="logout()"
                  class="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-smooth"
                >
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </button>
              </div>
            </div>
          </div>
        </header>

        <main class="container mx-auto px-6 py-8">
          <!-- Progress Indicator -->
          <div
            class="flex items-center gap-4 p-4 bg-white rounded-lg shadow-soft mb-8"
          >
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center"
              >
                <i class="fas fa-check text-sm"></i>
              </div>
              <span class="text-green-600">Upload Image</span>
            </div>
            <i class="fas fa-arrow-right w-4 h-4 text-gray-400"></i>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center"
              >
                <i class="fas fa-check text-sm"></i>
              </div>
              <span class="text-green-600">Select Genes</span>
            </div>
            <i class="fas fa-arrow-right w-4 h-4 text-gray-400"></i>
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 bg-primary-gradient text-white rounded-full flex items-center justify-center font-bold"
              >
                3
              </div>
              <span class="font-medium text-purple-600">View Heatmap</span>
            </div>
          </div>

          <!-- Gene Selector -->
          <div class="max-w-6xl mx-auto mb-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div
                    class="w-10 h-10 bg-primary-gradient rounded-lg flex items-center justify-center mr-3"
                  >
                    <i class="fas fa-dna text-white"></i>
                  </div>
                  <div>
                    <label
                      for="heatmap-gene-select"
                      class="block text-lg font-bold text-gray-900"
                      >Selected Gene:</label
                    >
                    <p class="text-sm text-gray-600">Choose a gene to visualize expression</p>
                  </div>
                </div>
                <select 
                  id="heatmap-gene-select" 
                  class="input w-64 text-lg font-semibold"
                  onchange="switchGene(this.value)"
                >
                  <!-- Will be populated dynamically from API response -->
                  <option value="ABCC11">Loading genes...</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Side-by-Side Image Comparison -->
          <div class="max-w-7xl mx-auto">
            <div class="bg-white rounded-3xl shadow-2xl p-8">
              
              <!-- Loading State -->
              <div
                id="heatmap-loading"
                class="flex items-center justify-center py-32"
              >
                <div class="text-center">
                  <div
                    class="inline-block animate-spin rounded-full h-12 w-12 border-b-4 border-purple-600 mb-4"
                  ></div>
                  <p class="text-xl font-semibold text-gray-700">Generating heatmap...</p>
                  <p class="text-sm text-gray-500 mt-2">This may take a few moments</p>
                </div>
              </div>

              <!-- Image Comparison Grid -->
              <div id="heatmap-comparison" class="hidden">
                
                <!-- Tabs for Heatmap vs Overlay vs Contour -->
                <div class="flex border-b border-gray-200 mb-6">
                  <button
                    id="tab-heatmap"
                    onclick="switchTab('heatmap')"
                    class="px-6 py-3 font-semibold text-purple-600 border-b-2 border-purple-600 transition-smooth"
                  >
                    <i class="fas fa-chart-area mr-2"></i>Heatmap View
                  </button>
                  <button
                    id="tab-overlay"
                    onclick="switchTab('overlay')"
                    class="px-6 py-3 font-semibold text-gray-500 border-b-2 border-transparent hover:text-purple-600 transition-smooth"
                  >
                    <i class="fas fa-layer-group mr-2"></i>Overlay View
                  </button>
                  <button
                    id="tab-contour"
                    onclick="switchTab('contour')"
                    class="px-6 py-3 font-semibold text-gray-500 border-b-2 border-transparent hover:text-purple-600 transition-smooth"
                  >
                    <i class="fas fa-wave-square mr-2"></i>Contour View
                  </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                  
                  <!-- Original Image -->
                  <div class="space-y-4">
                    <div class="flex items-center justify-between">
                      <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-image text-blue-600 mr-2"></i>
                        Original Image
                      </h3>
                      <span class="text-sm text-gray-500" id="original-filename">your_image.png</span>
                    </div>
                    <div class="relative bg-gray-100 rounded-xl overflow-hidden shadow-lg border-2 border-gray-200">
                      <img
                        id="original-image"
                        src=""
                        alt="Original Histology Image"
                        class="w-full h-auto"
                      />
                    </div>
                  </div>

                  <!-- Heatmap/Overlay Image (dynamically switches) -->
                  <div class="space-y-4">
                    <div class="flex items-center justify-between">
                      <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-chart-area text-purple-600 mr-2" id="viz-icon"></i>
                        <span id="heatmap-title">Predicted Expression - ABCC11</span>
                      </h3>
                      <button
                        onclick="downloadHeatmap()"
                        class="text-sm px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-smooth"
                      >
                        <i class="fas fa-download mr-1"></i>Download
                      </button>
                    </div>
                    <div class="relative bg-gray-900 rounded-xl overflow-hidden shadow-lg border-2 border-purple-300">
                      <img
                        id="heatmap-image"
                        src=""
                        alt="Gene Expression Heatmap"
                        class="w-full h-auto"
                      />
                      <!-- Color Scale Legend -->
                      <div class="absolute bottom-4 right-4 bg-white bg-opacity-90 rounded-lg p-3 shadow-lg">
                        <p class="text-xs font-semibold text-gray-700 mb-2">Log Expression</p>
                        <div class="flex items-center space-x-2">
                          <div class="w-32 h-4 rounded" style="background: linear-gradient(to right, #000080, #4169E1, #87CEEB, #FFD700, #FF8C00, #DC143C);"></div>
                          <div class="flex flex-col text-xs text-gray-600">
                            <span>5</span>
                            <span class="my-1">3</span>
                            <span>0</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>

                <!-- Stats Panel -->
                <div class="mt-8 grid grid-cols-4 gap-4">
                  <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 text-center">
                    <p class="text-sm text-blue-600 font-semibold mb-1">Image Size</p>
                    <p class="text-2xl font-bold text-blue-900" id="stat-size">-</p>
                  </div>
                  <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 text-center">
                    <p class="text-sm text-purple-600 font-semibold mb-1">Gene Selected</p>
                    <p class="text-2xl font-bold text-purple-900" id="stat-gene">ABCC11</p>
                  </div>
                  <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl p-4 text-center">
                    <p class="text-sm text-pink-600 font-semibold mb-1">Prediction Points</p>
                    <p class="text-2xl font-bold text-pink-900" id="stat-points">-</p>
                  </div>
                  <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 text-center">
                    <p class="text-sm text-green-600 font-semibold mb-1">Pearson Score</p>
                    <p class="text-2xl font-bold text-green-900" id="stat-pearson">-</p>
                  </div>
                </div>
                
                <!-- Gene Information Panel -->
                <div id="gene-info-panel" class="mt-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-6 hidden">
                  <h4 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                    <i class="fas fa-info-circle text-purple-600"></i>
                    Gene Information: <span id="gene-info-name" class="text-purple-600">-</span>
                  </h4>
                  <div class="space-y-4">
                    <div>
                      <p class="text-sm font-semibold text-gray-700 mb-1">
                        <i class="fas fa-tag text-blue-500 mr-2"></i>Full Name
                      </p>
                      <p class="text-sm text-gray-600 bg-white p-3 rounded-lg" id="gene-full-name">-</p>
                    </div>
                    <div>
                      <p class="text-sm font-semibold text-gray-700 mb-1">
                        <i class="fas fa-cogs text-green-500 mr-2"></i>Function
                      </p>
                      <p class="text-sm text-gray-600 bg-white p-3 rounded-lg leading-relaxed" id="gene-function">-</p>
                    </div>
                    <div>
                      <p class="text-sm font-semibold text-gray-700 mb-1">
                        <i class="fas fa-clinic-medical text-red-500 mr-2"></i>Clinical Significance
                      </p>
                      <p class="text-sm text-gray-600 bg-white p-3 rounded-lg leading-relaxed" id="gene-clinical">-</p>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

              <div class="flex justify-between">
                <button
                  onclick="showPage('gene-selection')"
                  class="button button-secondary"
                >
                  <i class="fas fa-arrow-left mr-2"></i>Back to Gene Selection
                </button>
                <div class="flex gap-2">
                  <button
                    onclick="startNewPrediction()"
                    class="button button-secondary"
                  >
                    <i class="fas fa-plus mr-2"></i>New Prediction
                  </button>
                  <button
                    id="download-results-btn"
                    class="button button-primary"
                  >
                    <i class="fas fa-download mr-2"></i>Download Results
                  </button>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- Training Page -->
      <!-- Training Page -->
      <div id="training-page" class="page">
        <header class="bg-white shadow-lg border-b sticky top-0 z-40">
          <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <button
                  onclick="showPage('dashboard')"
                  class="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-smooth"
                >
                  <i class="fas fa-arrow-left"></i>
                  <span>Back</span>
                </button>
                <div class="w-8 h-8 bg-primary-gradient rounded-lg flex items-center justify-center">
                  <i class="fas fa-brain text-white"></i>
                </div>
                <div>
                  <h1 class="text-2xl font-bold text-gray-900">
                    Model Training Portal
                  </h1>
                  <p class="text-sm text-gray-600">
                    Fine-tune the model on your own data
                  </p>
                </div>
              </div>

              <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-600">
                  Welcome, <span id="training-user-name">Demo User</span>
                </div>
                <button
                  onclick="logout()"
                  class="flex items-center space-x-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-smooth"
                >
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Logout</span>
                </button>
              </div>
            </div>
          </div>
        </header>

        <main class="container mx-auto px-6 py-8">
          <!-- Instructions Panel -->
          <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 mb-8 border border-purple-200">
            <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center gap-2">
              <i class="fas fa-info-circle text-purple-600"></i>
              Training Data Requirements
            </h3>
            <div class="space-y-2 text-sm text-gray-700">
              <p><strong> Tissue Image:</strong> High-resolution histology image (.tif, .tiff, .png, .jpg)</p>
              <p><strong> CSV File:</strong> Must contain columns: <code class="bg-white px-2 py-1 rounded">x</code>, <code class="bg-white px-2 py-1 rounded">y</code>, and gene expression columns for genes you want to fine-tune</p>
              <p><strong>Example CSV:</strong> <code class="bg-white px-2 py-1 rounded">x,y,ESR1,ERBB2,GATA3</code> (coordinates + gene expression values)</p>
              <p><strong> Note:</strong> Training will create/overwrite your personal model. You can choose between Original Model and Your Trained Model for predictions.</p>
            </div>
          </div>

          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-3xl shadow-xl p-8">
              
              <!-- Upload Section -->
              <div class="space-y-6 mb-8">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                  <i class="fas fa-upload text-purple-600"></i>
                  Step 1: Upload Training Data
                </h3>
                
                <!-- Tissue Image Upload -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Tissue Image
                  </label>
                  <div
                    class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-purple-400 transition-smooth cursor-pointer"
                    onclick="document.getElementById('training-image-input').click()"
                  >
                    <i class="fas fa-image text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-600">
                      Click to upload tissue image
                    </p>
                    <p class="text-xs text-gray-500 mt-2">
                      TIF, TIFF, PNG, JPG supported
                    </p>
                  </div>
                  <input
                    type="file"
                    id="training-image-input"
                    accept=".tif,.tiff,.png,.jpg,.jpeg"
                    class="hidden"
                  />
                  <div
                    id="training-image-display"
                    class="hidden mt-3 bg-gray-50 p-4 rounded-lg border border-gray-200"
                  >
                    <div class="flex items-center justify-between">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-file-image text-purple-600 text-xl"></i>
                        <div>
                          <p id="training-image-name" class="font-medium text-gray-900"></p>
                          <p id="training-image-size" class="text-sm text-gray-500"></p>
                        </div>
                      </div>
                      <button
                        onclick="clearTrainingImage()"
                        class="text-red-500 hover:text-red-700"
                      >
                        <i class="fas fa-times-circle text-xl"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- CSV Upload -->
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Gene Expression CSV
                  </label>
                  <div
                    class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-purple-400 transition-smooth cursor-pointer"
                    onclick="document.getElementById('training-csv-input').click()"
                  >
                    <i class="fas fa-file-csv text-4xl text-gray-400 mb-3"></i>
                    <p class="text-gray-600">
                      Click to upload CSV file
                    </p>
                    <p class="text-xs text-gray-500 mt-2">
                      Must contain: x, y, gene1, gene2, ...
                    </p>
                  </div>
                  <input
                    type="file"
                    id="training-csv-input"
                    accept=".csv"
                    class="hidden"
                  />
                  <div
                    id="training-csv-display"
                    class="hidden mt-3 bg-gray-50 p-4 rounded-lg border border-gray-200"
                  >
                    <div class="flex items-center justify-between">
                      <div class="flex items-center space-x-3">
                        <i class="fas fa-file-csv text-green-600 text-xl"></i>
                        <div>
                          <p id="training-csv-name" class="font-medium text-gray-900"></p>
                          <p id="training-csv-info" class="text-sm text-gray-500"></p>
                        </div>
                      </div>
                      <button
                        onclick="clearTrainingCSV()"
                        class="text-red-500 hover:text-red-700"
                      >
                        <i class="fas fa-times-circle text-xl"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <hr class="my-8 border-gray-200" />

              <!-- Training Parameters -->
              <div class="space-y-6 mb-8">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                  <i class="fas fa-sliders-h text-purple-600"></i>
                  Step 2: Configure Training Parameters
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Epochs -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Number of Epochs
                    </label>
                    <input
                      type="number"
                      id="training-epochs"
                      value="10"
                      min="1"
                      max="100"
                      class="input"
                      placeholder="e.g., 10"
                    />
                    <p class="text-xs text-gray-500 mt-1">Recommended: 10-50</p>
                  </div>

                  <!-- Learning Rate -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Learning Rate
                    </label>
                    <input
                      type="number"
                      id="training-lr"
                      value="0.0001"
                      step="0.00001"
                      min="0.00001"
                      max="0.01"
                      class="input"
                      placeholder="e.g., 0.0001"
                    />
                    <p class="text-xs text-gray-500 mt-1">Recommended: 0.0001</p>
                  </div>

                  <!-- Batch Size -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Batch Size
                    </label>
                    <select id="training-batch-size" class="input">
                      <option value="8">8</option>
                      <option value="16" selected>16</option>
                      <option value="32">32</option>
                      <option value="64">64</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Recommended: 16</p>
                  </div>

                  <!-- Validation Split -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Validation Split (%)
                    </label>
                    <input
                      type="number"
                      id="training-val-split"
                      value="20"
                      min="0"
                      max="50"
                      class="input"
                      placeholder="e.g., 20"
                    />
                    <p class="text-xs text-gray-500 mt-1">Recommended: 20%</p>
                  </div>
                </div>
              </div>

              <hr class="my-8 border-gray-200" />

              <!-- Training Status -->
              <div id="training-status-section" class="hidden mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                  <i class="fas fa-chart-line text-purple-600"></i>
                  Training Progress
                </h3>
                <div class="bg-gray-50 rounded-xl p-6 space-y-4">
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold text-gray-700">Status:</span>
                    <span id="training-status-text" class="text-sm text-purple-600 font-medium">Initializing...</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold text-gray-700">Epoch:</span>
                    <span id="training-epoch-text" class="text-sm text-gray-900">0 / 10</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div
                      id="training-progress-bar"
                      class="bg-gradient-to-r from-purple-500 to-pink-500 h-4 rounded-full transition-all duration-300"
                      style="width: 0%"
                    ></div>
                  </div>
                  <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span class="text-gray-600">Training Loss:</span>
                      <span id="training-loss" class="ml-2 font-semibold text-gray-900">-</span>
                    </div>
                    <div>
                      <span class="text-gray-600">Validation Loss:</span>
                      <span id="training-val-loss" class="ml-2 font-semibold text-gray-900">-</span>
                    </div>
                  </div>
                  <div id="training-log" class="mt-4 bg-white border border-gray-200 rounded-lg p-3 h-32 overflow-y-auto font-mono text-xs text-gray-700">
                    <!-- Training logs will appear here -->
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex justify-between">
                <button
                  onclick="showPage('dashboard')"
                  class="button button-secondary"
                >
                  <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                </button>
                <button
                  id="start-training-btn"
                  onclick="startTraining()"
                  disabled
                  class="button button-primary opacity-50"
                >
                  <i class="fas fa-play mr-2"></i>
                  <span id="training-btn-text">Start Training</span>
                </button>
              </div>

            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
      console.log(" SpatX Frontend Started");

      // Global state
      let currentUser = null;
      let authToken = null;
      let selectedGenes = new Set();
      let uploadedFile = null;
      let uploadedImagePath = null;
      let predictionDensity = "low";
      let geneCategories = {};  // Will be populated from prediction response
      let geneMetadata = {};    // Will be populated from prediction response

      // API Configuration - Auto-detect based on current host
      const API_BASE_URL = window.location.hostname === 'localhost' 
        ? "http://localhost:9001"  // Changed to 9001 for local dev
        : `http://${window.location.hostname}:9001`;

      // API Client for real backend integration
      class SpatXAPI {
        async request(
          endpoint,
          method = "GET",
          data = null,
          isFormData = false
        ) {
          const url = `${API_BASE_URL}/${endpoint}`;
          const headers = {};

          // CRITICAL: Always check for token in localStorage if not in memory
          const token = authToken || localStorage.getItem("authToken");
          
          // Reduce logging spam for training progress polling
          const isProgressPoll = endpoint.includes('train/progress');
          
          if (token) {
            headers["Authorization"] = `Bearer ${token}`;
            if (!isProgressPoll) {
              console.log(` Token attached to ${endpoint} request`);
            }
          } else {
            console.warn(` No token available for ${endpoint} request`);
          }

          let body;
          if (isFormData) {
            body = data; // FormData object
          } else if (data) {
            headers["Content-Type"] = "application/json";
            body = JSON.stringify(data);
          }

          const options = { method, headers, body };
          
          if (!isProgressPoll) {
            console.log(` API Request: ${method} ${endpoint}`, {
              hasToken: !!token,
              isFormData,
              headers: Object.keys(headers)
            });
          }

          try {
            const response = await fetch(url, options);

            if (!response.ok) {
              const errorData = await response.json();
              console.error(` API Error (${response.status}):`, errorData);
              throw new Error(errorData.detail || "Something went wrong");
            }

            const result = await response.json();
            if (!isProgressPoll) {
              console.log(` API Success: ${endpoint}`, result);
            }
            return result;
          } catch (error) {
            console.error("API request failed:", error);
            throw error;
          }
        }

        // Authentication
        async register(username, email, password) {
          return this.request("auth/register", "POST", {
            username,
            email,
            password,
          });
        }

        async login(username, password) {
          return this.request("auth/login", "POST", { username, password });
        }

        async getCurrentUser() {
          return this.request("users/me");
        }

        async getCredits() {
          return this.request("auth/credits");
        }

        // File operations
        async uploadFile(file, fileType) {
          const formData = new FormData();
          formData.append("file", file);

          return this.request("upload/image", "POST", formData, true);
        }

        // Model operations
        async getModels() {
          return this.request("models");
        }

        async predict(imageFile, coordinatesCsv, modelName = "working_model", selectedGenes = "all") {
          const formData = new FormData();
          formData.append("image_file", imageFile);
          formData.append("coordinates_csv", coordinatesCsv);
          formData.append("model_name", modelName);
          formData.append("output_format", "json");
          formData.append("selected_genes", selectedGenes);

          return this.request("predict", "POST", formData, true);
        }

        async uploadCoordinates(csvContent, filename) {
          // Create a Blob from CSV content
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const file = new File([blob], filename, { type: 'text/csv' });
          
          const formData = new FormData();
          formData.append("file", file);

          return this.request("upload/csv", "POST", formData, true);
        }

        async train(params) {
          return this.request("train", "POST", params);
        }
      }

      const api = new SpatXAPI();

      // All 50 genes from your working model
      const allGenes = [
        "ABCC11",
        "ADH1B",
        "ADIPOQ",
        "ANKRD30A",
        "AQP1",
        "AQP3",
        "CCR7",
        "CD3E",
        "CEACAM6",
        "CEACAM8",
        "CLIC6",
        "CYTIP",
        "DST",
        "ERBB2",
        "ESR1",
        "FASN",
        "GATA3",
        "IL2RG",
        "IL7R",
        "KIT",
        "KLF5",
        "KRT14",
        "KRT5",
        "KRT6B",
        "MMP1",
        "MMP12",
        "MS4A1",
        "MUC6",
        "MYBPC1",
        "MYH11",
        "MYLK",
        "OPRPN",
        "OXTR",
        "PIGR",
        "PTGDS",
        "PTN",
        "PTPRC",
        "SCD",
        "SCGB2A1",
        "SERHL2",
        "SERPINA3",
        "SFRP1",
        "SLAMF7",
        "TACSTD2",
        "TCL1A",
        "TENT5C",
        "TOP2A",
        "TPSAB1",
        "TRAC",
        "VWF",
      ];

      // Page navigation
      function showPage(pageId) {
        console.log(` Navigating to: ${pageId}`);

        // Check authentication for protected pages
        const protectedPages = ['dashboard', 'prediction', 'gene-selection', 'heatmap', 'training'];
        if (protectedPages.includes(pageId) && !authToken) {
          showToast('Please login first', 'error');
          pageId = 'login';
        }

        // Hide all pages
        document.querySelectorAll(".page").forEach((page) => {
          page.classList.remove("active");
        });

        // Show selected page
        const page = document.getElementById(pageId + "-page");
        if (page) {
          page.classList.add("active");
        }

        // Update user names and credits on all pages
        if (currentUser) {
          const userNameElements = [
            "user-name",
            "prediction-user-name",
            "gene-user-name",
            "heatmap-user-name",
            "training-user-name"
          ];
          userNameElements.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = currentUser.username;
          });

          // Update credits display
          const creditsEl = document.getElementById("dashboard-credits");
          if (creditsEl) creditsEl.textContent = currentUser.credits || 0;
        }
        
        // Check if user has trained model when navigating to prediction page
        if (pageId === 'prediction') {
          checkUserModel();
        }
        
        // Initialize heatmap page when navigating to it
        if (pageId === 'heatmap') {
          initializeHeatmapPage();
          initializeHeatmap();
        }

        // Page-specific initialization
        if (pageId === "gene-selection") {
          initializeGeneSelection();
        } else if (pageId === "heatmap") {
          initializeHeatmap();
        }
      }

      // Toast notifications
      function showToast(message, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");

        toast.className = `toast ${type}`;
        toast.innerHTML = `
           <div class="flex items-center space-x-2">
             <i class="fas fa-${
               type === "success"
                 ? "check-circle"
                 : type === "error"
                 ? "exclamation-circle"
                 : "info-circle"
             }"></i>
             <span>${message}</span>
             <button onclick="this.closest('.toast').remove()" class="ml-4 hover:opacity-70">
               <i class="fas fa-times"></i>
             </button>
           </div>
         `;

        container.appendChild(toast);

        // Show toast
        setTimeout(() => toast.classList.add("show"), 100);

        // Auto-remove
        setTimeout(() => {
          toast.classList.remove("show");
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 300);
        }, 4000);
      }

      // Refresh user credits from backend
      async function refreshCredits() {
        if (!authToken) return;

        try {
          const response = await api.getCredits();
          if (currentUser) {
            currentUser.credits = response.credits;
            localStorage.setItem("user", JSON.stringify(currentUser));

            // Update all credit displays
            const creditsEl = document.getElementById("dashboard-credits");
            if (creditsEl) creditsEl.textContent = currentUser.credits;
          }
        } catch (error) {
          console.error("Failed to refresh credits:", error);
        }
      }

      // Form switching
      function showLoginForm() {
        document.getElementById("login-form").classList.remove("hidden");
        document.getElementById("register-form").classList.add("hidden");
        document.getElementById("login-error").classList.add("hidden");
      }

      function showRegisterForm() {
        document.getElementById("login-form").classList.add("hidden");
        document.getElementById("register-form").classList.remove("hidden");
        document.getElementById("register-error").classList.add("hidden");
      }

      // Authentication
      async function handleLogin(event) {
        event.preventDefault();

        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;
        const button = document.getElementById("login-btn");

        button.disabled = true;
        button.textContent = "Signing in...";

        try {
          const response = await api.login(username, password);

          authToken = response.access_token;
          currentUser = response.user;

          // Store in localStorage
          localStorage.setItem("authToken", authToken);
          localStorage.setItem("user", JSON.stringify(currentUser));

          document.getElementById("user-name").textContent =
            currentUser.username;
          showToast(
            `Welcome back, ${currentUser.username}! You have ${currentUser.credits} credits.`,
            "success"
          );
          await refreshCredits();
          showPage("dashboard");
        } catch (error) {
          showError(
            error.message || "Login failed. Please check your credentials."
          );
        } finally {
          button.disabled = false;
          button.textContent = "Sign In";
        }
      }

      async function handleRegister(event) {
        event.preventDefault();

        const username = document.getElementById("register-username").value;
        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;
        const button = document.getElementById("register-btn");

        button.disabled = true;
        button.textContent = "Creating account...";

        try {
          const response = await api.register(username, email, password);

          authToken = response.access_token;
          currentUser = response.user;

          // Store in localStorage
          localStorage.setItem("authToken", authToken);
          localStorage.setItem("user", JSON.stringify(currentUser));

          showToast(
            `Welcome ${currentUser.username}! You have ${currentUser.credits} credits.`,
            "success"
          );
          showPage("dashboard");
        } catch (error) {
          const errorDiv = document.getElementById("register-error");
          errorDiv.querySelector("p").textContent =
            error.message || "Registration failed. Please try again.";
          errorDiv.classList.remove("hidden");
        } finally {
          button.disabled = false;
          button.textContent = "Create Account";
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById("login-error");
        errorDiv.querySelector("p").textContent = message;
        errorDiv.classList.remove("hidden");
      }

      function logout() {
        currentUser = null;
        authToken = null;
        selectedGenes.clear();
        uploadedFile = null;
        uploadedImagePath = null;

        localStorage.removeItem("authToken");
        localStorage.removeItem("user");

        showToast("Logged out successfully", "info");
        showPage("login");
      }

      // File Upload Functions
      function initializePredictionUpload() {
        const uploadArea = document.getElementById("prediction-upload-area");
        const fileInput = document.getElementById("prediction-file-input");
        const proceedBtn = document.getElementById("prediction-proceed-btn");

        uploadArea.addEventListener("click", () => fileInput.click());
        uploadArea.addEventListener("dragover", handleDragOver);
        uploadArea.addEventListener("dragleave", handleDragLeave);
        uploadArea.addEventListener("drop", handleDrop);
        fileInput.addEventListener("change", (e) =>
          handleFileSelect(e.target.files[0])
        );

        // Density selection
        document.querySelectorAll('input[name="density"]').forEach((radio) => {
          radio.addEventListener("change", (e) => {
            predictionDensity = e.target.value;
            console.log("Density selected:", predictionDensity);
          });
        });

        proceedBtn.addEventListener("click", () => {
          if (uploadedFile) {
            showToast("Proceeding to gene selection...", "success");
            showPage("gene-selection");
          }
        });
      }

      function handleDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add("border-purple-400", "bg-purple-50");
      }

      function handleDragLeave(event) {
        event.preventDefault();
        event.currentTarget.classList.remove(
          "border-purple-400",
          "bg-purple-50"
        );
      }

      function handleDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove(
          "border-purple-400",
          "bg-purple-50"
        );
        const files = event.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      }

      async function handleFileSelect(file) {
        if (!file) return;

        // Validate file type
        const validTypes = ["image/png", "image/jpeg", "image/tiff"];
        if (
          !validTypes.includes(file.type) &&
          !file.name.toLowerCase().match(/\.(png|jpg|jpeg|tif|tiff)$/)
        ) {
          showToast(
            "Please select a valid image file (PNG, JPG, TIF, TIFF)",
            "error"
          );
          return;
        }

        uploadedFile = file;

        // Show file info
        document.getElementById("prediction-file-name").textContent = file.name;
        document.getElementById("prediction-file-size").textContent =
          formatFileSize(file.size);
        document
          .getElementById("prediction-file-display")
          .classList.remove("hidden");

        showToast(`File "${file.name}" selected. Uploading...`, "info");

        try {
          // Upload file to backend
          const response = await api.uploadFile(file, "image");
          uploadedImagePath = response.filename;

          // Enable proceed button
          const proceedBtn = document.getElementById("prediction-proceed-btn");
          proceedBtn.disabled = false;
          proceedBtn.classList.remove("opacity-50");

          showToast(`File uploaded successfully!`, "success");
        } catch (error) {
          showToast(`Upload failed: ${error.message}`, "error");
          clearPredictionFile();
        }
      }

      function clearPredictionFile() {
        uploadedFile = null;
        document
          .getElementById("prediction-file-display")
          .classList.add("hidden");
        document.getElementById("prediction-file-input").value = "";

        const proceedBtn = document.getElementById("prediction-proceed-btn");
        proceedBtn.disabled = true;
        proceedBtn.classList.add("opacity-50");

        showToast("File cleared", "info");
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // Gene Selection Functions
      function initializeGeneSelection() {
        const categoriesContainer = document.getElementById("gene-categories-container");
        const searchInput = document.getElementById("gene-search");
        const selectAllBtn = document.getElementById("select-all-genes-btn");
        const clearAllBtn = document.getElementById("clear-all-genes-btn");
        const generateBtn = document.getElementById("generate-predictions-btn");

        // Define default categories (will be used if backend doesn't provide them)
        const defaultCategories = {
          "Hormone Receptors & Signaling": ["ESR1", "ERBB2", "GATA3", "KLF5"],
          "Growth Factor Receptors & Proliferation": ["KIT", "OXTR", "TOP2A"],
          "Basal/Myoepithelial Markers": ["KRT5", "KRT14", "KRT6B"],
          "Extracellular Matrix & Metastasis": ["MMP1", "MMP12"],
          "Immune Cell Markers": ["CD3E", "CCR7", "IL2RG", "IL7R", "MS4A1", "PTPRC", "SLAMF7", "TCL1A", "TRAC"],
          "Immune-Related Cell Adhesion": ["CEACAM6", "CEACAM8"],
          "Lipid Metabolism": ["FASN", "SCD", "ADIPOQ"],
          "Water & Small Molecule Transport": ["AQP1", "AQP3"],
          "Secreted & Glandular Markers": ["PIGR", "MUC6", "SCGB2A1", "PTGDS", "TPSAB1", "SERPINA3", "PTN"],
          "Cytoskeletal & Contractile Proteins": ["MYH11", "MYLK", "MYBPC1"],
          "Signaling & Regulatory Proteins": ["SFRP1", "CLIC6", "CYTIP", "OPRPN", "SERHL2", "TENT5C", "ANKRD30A", "ABCC11"],
          "Structural & Adhesion Proteins": ["DST", "VWF", "TACSTD2"],
          "Enzyme & Metabolic Function": ["ADH1B"]
        };
        
        const categoriesToUse = Object.keys(geneCategories).length > 0 ? geneCategories : defaultCategories;

        // Populate genes by category
        categoriesContainer.innerHTML = Object.entries(categoriesToUse)
          .map(([category, genes], index) => `
            <div class="border border-gray-200 rounded-lg overflow-hidden">
              <div class="flex items-center justify-between bg-gradient-to-r from-purple-50 to-pink-50 px-4 py-3 cursor-pointer hover:bg-purple-100 transition-smooth" onclick="toggleCategory('category-${index}')">
                <div class="flex items-center gap-3">
                  <i class="fas fa-chevron-right category-chevron text-purple-600 transition-transform" id="chevron-category-${index}"></i>
                  <h5 class="font-semibold text-gray-800">${category}</h5>
                  <span class="text-xs bg-white px-2 py-1 rounded-full text-gray-600">${genes.length} genes</span>
                </div>
                <button onclick="event.stopPropagation(); selectCategoryGenes('${category}', ${JSON.stringify(genes).replace(/"/g, '&quot;')})" 
                        class="text-xs px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-smooth">
                  Select All
                </button>
              </div>
              <div id="category-${index}" class="hidden px-4 py-3 bg-white">
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                  ${genes.map(gene => `
                    <button class="gene-button px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50 transition-smooth font-medium" 
                            data-gene="${gene}" 
                            data-category="${category}"
                            onclick="toggleGene('${gene}')">
                      ${gene}
                    </button>
                  `).join('')}
                </div>
              </div>
            </div>
          `).join('');

        // Search functionality
        searchInput.addEventListener("input", (e) => {
          const query = e.target.value.toLowerCase();
          document.querySelectorAll(".gene-button").forEach((button) => {
            const gene = button.getAttribute("data-gene").toLowerCase();
            const category = button.getAttribute("data-category");
            if (gene.includes(query)) {
              button.style.display = "block";
              // Show parent category if any gene matches
              const categoryDiv = button.closest('[id^="category-"]');
              if (categoryDiv) categoryDiv.classList.remove('hidden');
            } else {
              button.style.display = "none";
            }
          });
        });

        // Select/Clear all
        selectAllBtn.addEventListener("click", () => {
          allGenes.forEach((gene) => selectedGenes.add(gene));
          updateGeneSelection();
          showToast(`Selected all ${allGenes.length} genes`, "success");
        });

        clearAllBtn.addEventListener("click", () => {
          selectedGenes.clear();
          updateGeneSelection();
          showToast("Cleared all gene selections", "info");
        });

        generateBtn.addEventListener("click", generatePredictions);

        updateGeneSelection();
      }
      
      // Toggle category expand/collapse
      function toggleCategory(categoryId) {
        const categoryDiv = document.getElementById(categoryId);
        const chevron = document.getElementById('chevron-' + categoryId);
        categoryDiv.classList.toggle('hidden');
        chevron.classList.toggle('fa-chevron-right');
        chevron.classList.toggle('fa-chevron-down');
      }
      
      // Select all genes in a category
      function selectCategoryGenes(categoryName, genes) {
        genes.forEach(gene => selectedGenes.add(gene));
        updateGeneSelection();
        showToast(`Selected all genes in ${categoryName}`, "success");
      }

      function toggleGene(gene) {
        if (selectedGenes.has(gene)) {
          selectedGenes.delete(gene);
        } else {
          selectedGenes.add(gene);
        }
        updateGeneSelection();
      }

      function updateGeneSelection() {
        const selectedCount = selectedGenes.size;
        document.getElementById("selected-count").textContent = selectedCount;

        // Update gene button states
        document.querySelectorAll(".gene-button").forEach((button) => {
          const gene = button.getAttribute("data-gene");
          if (selectedGenes.has(gene)) {
            button.classList.add("selected");
          } else {
            button.classList.remove("selected");
          }
        });

        // Update selected genes display
        const display = document.getElementById("selected-genes-display");
        const list = document.getElementById("selected-genes-list");

        if (selectedCount > 0) {
          display.classList.remove("hidden");
          list.innerHTML = Array.from(selectedGenes)
            .map(
              (gene) =>
                `<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">${gene}</span>`
            )
            .join("");
        } else {
          display.classList.add("hidden");
        }

        // Update generate button
        const generateBtn = document.getElementById("generate-predictions-btn");
        if (selectedCount > 0) {
          generateBtn.disabled = false;
          generateBtn.classList.remove("opacity-50");
        } else {
          generateBtn.disabled = true;
          generateBtn.classList.add("opacity-50");
        }
      }

      function generatePredictions() {
        if (selectedGenes.size === 0) {
          showToast("Please select at least one gene", "error");
          return;
        }

        const generateBtn = document.getElementById("generate-predictions-btn");
        const generateBtnText = document.getElementById("generate-btn-text");

        generateBtn.disabled = true;
        generateBtn.classList.add("opacity-50");
        generateBtnText.innerHTML =
          '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';

        showToast(
          `Generating predictions for ${selectedGenes.size} genes...`,
          "info"
        );

        // Simulate API call
        setTimeout(() => {
          // For demo, we'll just show ABCC11 since that's what our backend supports
          showToast("Predictions generated successfully!", "success");
          showPage("heatmap");

          generateBtn.disabled = false;
          generateBtn.classList.remove("opacity-50");
          generateBtnText.innerHTML =
            'Generate Predictions <i class="fas fa-chart-area ml-2"></i>';
        }, 3000);
      }

      // Heatmap Functions
      function initializeHeatmapPage() {
        const geneSelect = document.getElementById("heatmap-gene-select");
        const downloadBtn = document.getElementById("download-results-btn");

        // Populate gene dropdown from prediction results (all 50 genes)
        if (predictionResults && predictionResults.genes && predictionResults.genes.length > 0) {
          geneSelect.innerHTML = predictionResults.genes
            .map((gene) => `<option value="${gene}">${gene}</option>`)
            .join("");
          console.log(` Loaded ${predictionResults.genes.length} genes into dropdown`);
        } else {
          // Fallback
          geneSelect.innerHTML = '<option value="ABCC11">ABCC11</option>';
        }

        geneSelect.addEventListener("change", (e) => {
          const selectedGene = e.target.value;
          document.getElementById(
            "heatmap-gene-label"
          ).textContent = `${selectedGene} Expression`;
          showToast(`Switched to ${selectedGene} heatmap`, "info");
        });

        downloadBtn.addEventListener("click", downloadResults);
        
        // Initialize stats boxes
        updateStatsBoxes();

        // Don't call old loadHeatmap() - it's replaced by displayHeatmap()
        // The initializeHeatmap() will be called from showPage()
      }
      
      // Helper function to update stats boxes
      function updateStatsBoxes(geneName = null) {
        // Image Size
        if (uploadedImageDimensions.width > 0 && uploadedImageDimensions.height > 0) {
          document.getElementById('stat-size').textContent = 
            `${uploadedImageDimensions.width}  ${uploadedImageDimensions.height}`;
        }
        
        // Prediction Points
        if (predictionResults && predictionResults.num_spots) {
          document.getElementById('stat-points').textContent = 
            predictionResults.num_spots.toLocaleString();
        }
        
        // Gene (if provided)
        const currentGene = geneName || (predictionResults && predictionResults.genes && predictionResults.genes.length > 0 ? predictionResults.genes[0] : null);
        if (currentGene) {
          document.getElementById('stat-gene').textContent = currentGene;
          
          // Update Pearson score and gene info if metadata is available
          if (geneMetadata && geneMetadata[currentGene]) {
            const metadata = geneMetadata[currentGene];
            
            // Pearson Score
            const pearsonScore = metadata.pearson_correlation || 0.57;
            document.getElementById('stat-pearson').textContent = pearsonScore.toFixed(2);
            
            // Gene Information Panel
            document.getElementById('gene-info-name').textContent = currentGene;
            document.getElementById('gene-full-name').textContent = metadata.full_name || currentGene;
            document.getElementById('gene-function').textContent = metadata.function || 'Information not available';
            document.getElementById('gene-clinical').textContent = metadata.clinical_significance || 'Information not available';
            
            // Show gene info panel
            document.getElementById('gene-info-panel').classList.remove('hidden');
          } else {
            // No metadata available - hide gene info panel
            document.getElementById('stat-pearson').textContent = '0.57';
            document.getElementById('gene-info-panel').classList.add('hidden');
          }
        }
      }

      function downloadResults() {
        showToast("Downloading results...", "info");
        // In a real app, this would download the actual CSV and images
        setTimeout(() => {
          showToast("Results downloaded successfully!", "success");
        }, 1000);
      }

      function startNewPrediction() {
        selectedGenes.clear();
        uploadedFile = null;
        showToast("Starting new prediction workflow...", "info");
        showPage("prediction");
      }

      // ========================================================================
      // MODEL SELECTION FUNCTIONS
      // ========================================================================
      
      let userHasModel = false;
      let selectedModel = 'working_model';  // Default to original model
      
      async function checkUserModel() {
        try {
          const response = await api.request('train/has_model');
          userHasModel = response.has_model;
          
          const userModelOption = document.getElementById('user-model-option');
          if (userHasModel && userModelOption) {
            userModelOption.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Failed to check user model:', error);
        }
      }
      
      function handleModelSelection() {
        const selected = document.querySelector('input[name="model-select"]:checked')?.value;
        if (selected === 'user') {
          selectedModel = `user_${currentUser.id}_model`;
          showToast('Using your trained model', 'info');
        } else {
          selectedModel = 'working_model';
          showToast('Using original 50-gene model', 'info');
        }
      }
      
      // ========================================================================
      // TRAINING PORTAL FUNCTIONS
      // ========================================================================
      
      let trainingImageFile = null;
      let trainingCSVFile = null;
      let trainingInterval = null;
      
      // Handle training image upload
      document.getElementById('training-image-input')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          trainingImageFile = file;
          document.getElementById('training-image-name').textContent = file.name;
          document.getElementById('training-image-size').textContent = formatFileSize(file.size);
          document.getElementById('training-image-display').classList.remove('hidden');
          checkTrainingReadiness();
        }
      });
      
      // Handle training CSV upload
      document.getElementById('training-csv-input')?.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          trainingCSVFile = file;
          document.getElementById('training-csv-name').textContent = file.name;
          // Read CSV to show info
          const reader = new FileReader();
          reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const geneColumns = headers.filter(h => h !== 'x' && h !== 'y');
            document.getElementById('training-csv-info').textContent = 
              `${lines.length - 1} samples, ${geneColumns.length} genes: ${geneColumns.slice(0, 3).join(', ')}${geneColumns.length > 3 ? '...' : ''}`;
          };
          reader.readAsText(file);
          document.getElementById('training-csv-display').classList.remove('hidden');
          checkTrainingReadiness();
        }
      });
      
      function clearTrainingImage() {
        trainingImageFile = null;
        document.getElementById('training-image-input').value = '';
        document.getElementById('training-image-display').classList.add('hidden');
        checkTrainingReadiness();
      }
      
      function clearTrainingCSV() {
        trainingCSVFile = null;
        document.getElementById('training-csv-input').value = '';
        document.getElementById('training-csv-display').classList.add('hidden');
        checkTrainingReadiness();
      }
      
      function checkTrainingReadiness() {
        const btn = document.getElementById('start-training-btn');
        if (trainingImageFile && trainingCSVFile) {
          btn.disabled = false;
          btn.classList.remove('opacity-50');
        } else {
          btn.disabled = true;
          btn.classList.add('opacity-50');
        }
      }
      
      async function startTraining() {
        // Check authentication first
        if (!authToken && !localStorage.getItem("authToken")) {
          showToast('Please login first', 'error');
          showPage('login');
          return;
        }
        
        if (!trainingImageFile || !trainingCSVFile) {
          showToast('Please upload both image and CSV files', 'error');
          return;
        }
        
        // Get training parameters
        const epochs = parseInt(document.getElementById('training-epochs').value);
        const learningRate = parseFloat(document.getElementById('training-lr').value);
        const batchSize = parseInt(document.getElementById('training-batch-size').value);
        const valSplit = parseFloat(document.getElementById('training-val-split').value) / 100;
        
        // Show training status section
        document.getElementById('training-status-section').classList.remove('hidden');
        document.getElementById('start-training-btn').disabled = true;
        document.getElementById('training-btn-text').textContent = 'Training...';
        
        try {
          // Upload files and start training
          // Backend will automatically extract genes from CSV columns
          const formData = new FormData();
          formData.append('image', trainingImageFile);
          formData.append('csv', trainingCSVFile);
          formData.append('epochs', epochs);
          formData.append('learning_rate', learningRate);
          formData.append('batch_size', batchSize);
          formData.append('validation_split', valSplit);
          
          console.log('Training request:', {
            imageFile: trainingImageFile.name,
            csvFile: trainingCSVFile.name,
            epochs,
            learningRate,
            batchSize,
            valSplit,
            hasToken: !!(authToken || localStorage.getItem("authToken"))
          });
          
          showToast('Starting model training...', 'info');
          addTrainingLog(' Initializing training...');
          
          const response = await api.request('train/start', 'POST', formData, true);
          
          if (response.status === 'success') {
            // Training started in background - poll for progress
            addTrainingLog(` Training started!`);
            addTrainingLog(`Job ID: ${response.job_id}`);
            addTrainingLog(`Genes: ${response.genes.join(', ')}`);
            addTrainingLog(`Training samples: ${response.samples}`);
            addTrainingLog(`Epochs: ${epochs}`);
            addTrainingLog('\n Training in progress...');
            
            // Update status
            const statusEl = document.getElementById('training-status-text');
            if (statusEl) statusEl.textContent = 'Running';
            
            // Save training state for recovery on page refresh
            saveTrainingState(response.job_id, epochs);
            
            // Start polling for progress
            startTrainingProgressPolling(response.job_id, epochs);
          }
          
        } catch (error) {
          showToast(`Training failed: ${error.message}`, 'error');
          addTrainingLog(` Error: ${error.message}`);
          resetTrainingUI();
        }
      }
      
      function startTrainingProgressPolling(jobId, totalEpochs) {
        let lastEpoch = 0;
        
        trainingInterval = setInterval(async () => {
          try {
            const progress = await api.request(`train/progress/${jobId}`);
            
            // Update UI elements with correct IDs
            const statusEl = document.getElementById('training-status-text');
            const epochEl = document.getElementById('training-epoch-text');
            const trainLossEl = document.getElementById('training-loss');
            const valLossEl = document.getElementById('training-val-loss');
            const progressBar = document.getElementById('training-progress-bar');
            
            if (statusEl) statusEl.textContent = progress.status.charAt(0).toUpperCase() + progress.status.slice(1);
            if (epochEl) epochEl.textContent = `${progress.current_epoch} / ${totalEpochs}`;
            
            const progressPercent = (progress.current_epoch / totalEpochs) * 100;
            if (progressBar) progressBar.style.width = `${progressPercent}%`;
            
            if (progress.train_loss && trainLossEl) {
              trainLossEl.textContent = progress.train_loss.toFixed(4);
            }
            if (progress.val_loss && valLossEl) {
              valLossEl.textContent = progress.val_loss.toFixed(4);
            }
            
            // Add log if new epoch
            if (progress.current_epoch > lastEpoch) {
              addTrainingLog(` Epoch ${progress.current_epoch}/${totalEpochs} - Train Loss: ${progress.train_loss?.toFixed(4) || 'N/A'}, Val Loss: ${progress.val_loss?.toFixed(4) || 'N/A'}`);
              lastEpoch = progress.current_epoch;
            }
            
            // Check if completed
            if (progress.status === 'completed') {
              clearInterval(trainingInterval);
              clearTrainingState(); // Clear saved training state
              addTrainingLog('\n Training completed successfully!');
              addTrainingLog(' Model saved to your account');
              showToast('Model training completed!', 'success');
              
              if (statusEl) {
                statusEl.textContent = 'Completed';
                statusEl.classList.remove('text-purple-600');
                statusEl.classList.add('text-green-600');
              }
              
              // Reload user data to update credits
              try {
                const userData = await api.getCurrentUser();
                currentUser = userData;
                localStorage.setItem('user', JSON.stringify(currentUser));
              } catch (e) {
                console.error('Failed to reload user data:', e);
              }
              
              resetTrainingUI();
            } else if (progress.status === 'failed') {
              clearInterval(trainingInterval);
              clearTrainingState(); // Clear saved training state
              addTrainingLog(`\n Training failed: ${progress.error || 'Unknown error'}`);
              showToast('Training failed', 'error');
              resetTrainingUI();
            }
            
          } catch (error) {
            console.error('Failed to get training progress:', error);
          }
        }, 5000); // Poll every 5 seconds (reduced frequency to prevent overload)
      }
      
      function addTrainingLog(message) {
        const logDiv = document.getElementById('training-log');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${timestamp}] ${message}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }
      
      function resetTrainingUI() {
        document.getElementById('start-training-btn').disabled = false;
        document.getElementById('training-btn-text').textContent = 'Start Training';
        if (trainingInterval) {
          clearInterval(trainingInterval);
          trainingInterval = null;
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        console.log(" DOM Content Loaded");

        // Check for stored auth
        const storedToken = localStorage.getItem("authToken");
        const storedUser = localStorage.getItem("user");

        if (storedToken && storedUser) {
          authToken = storedToken;
          currentUser = JSON.parse(storedUser);

          // Verify token is still valid
          api
            .getCurrentUser()
            .then((user) => {
              currentUser = user;
              localStorage.setItem("user", JSON.stringify(user));
              document.getElementById("user-name").textContent =
                currentUser.username;
              showPage("dashboard");
            })
            .catch(() => {
              // Token expired, clear storage
              logout();
            });
        }

        // Login and register forms
        document
          .getElementById("login-form")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("register-form")
          .addEventListener("submit", handleRegister);

        // Initialize prediction upload when on that page
        if (document.getElementById("prediction-page")) {
          initializePredictionUpload();
        }

        // Restore training state from localStorage if exists
        restoreTrainingState();
        
        console.log(" SpatX Frontend Ready");
      });
      
      // Save training state to localStorage when training starts
      function saveTrainingState(jobId, totalEpochs) {
        localStorage.setItem('activeTrainingJob', JSON.stringify({
          jobId: jobId,
          totalEpochs: totalEpochs,
          startTime: Date.now()
        }));
      }
      
      // Clear training state from localStorage
      function clearTrainingState() {
        localStorage.removeItem('activeTrainingJob');
      }
      
      // Restore training state on page load/refresh
      function restoreTrainingState() {
        const savedState = localStorage.getItem('activeTrainingJob');
        if (savedState) {
          try {
            const { jobId, totalEpochs, startTime } = JSON.parse(savedState);
            
            // Only restore if training started less than 24 hours ago
            const hoursSinceStart = (Date.now() - startTime) / (1000 * 60 * 60);
            if (hoursSinceStart < 24) {
              console.log(' Restoring training session:', jobId);
              addTrainingLog(' Resuming training session...');
              startTrainingProgressPolling(jobId, totalEpochs);
            } else {
              clearTrainingState();
            }
          } catch (e) {
            console.error('Failed to restore training state:', e);
            clearTrainingState();
          }
        }
      }
      
      // Warn user if they try to leave during training
      window.addEventListener('beforeunload', (e) => {
        if (trainingInterval) {
          e.preventDefault();
          e.returnValue = 'Training is in progress. If you leave, you can resume when you return.';
          return e.returnValue;
        }
      });

      // Prediction state
      let generatedCoordinatesFile = null;
      let predictionResults = null;
      let uploadedImageDimensions = { width: 0, height: 0 }; // Store actual image dimensions

      // Helper function to generate coordinates based on density
      function generateCoordinates(density = 'low', imageWidth = 2000, imageHeight = 2000) {
        // Define stride in pixels (gap between prediction points)
        // Stride-based approach: point count scales with image size
        const strideMap = {
          'low': 224,      // One point every 224 pixels (patch size, no overlap)
          'medium': 112,   // One point every 112 pixels (50% overlap)
          'high': 56,      // One point every 56 pixels (75% overlap)
          'full': 28       // One point every 28 pixels (87.5% overlap, very dense)
        };
        
        const stride = strideMap[density] || 224;
        const patchSize = 224;
        const padding = Math.ceil(patchSize / 2); // Half patch size as padding (112px)
        
        // Calculate usable area (minus padding on all sides)
        const usableWidth = imageWidth - (2 * padding);
        const usableHeight = imageHeight - (2 * padding);
        
        // Calculate how many points fit in each dimension
        const pointsX = Math.floor(usableWidth / stride) + 1;
        const pointsY = Math.floor(usableHeight / stride) + 1;
        
        const coords = [];
        
        // Generate grid of points with fixed stride
        for (let i = 0; i < pointsX; i++) {
          for (let j = 0; j < pointsY; j++) {
            const x = padding + (i * stride);
            const y = padding + (j * stride);
            coords.push({
              x: Math.round(x),
              y: Math.round(y)
            });
          }
        }
        
        console.log(`Generated ${coords.length} coordinates with padding=${padding}, range: x[${padding}, ${imageWidth-padding}], y[${padding}, ${imageHeight-padding}]`);
        
        return coords;
      }

      // Convert coordinates array to CSV string
      function coordinatesToCSV(coords) {
        let csv = 'x,y\n';
        coords.forEach(coord => {
          csv += `${coord.x},${coord.y}\n`;
        });
        return csv;
      }

      // Main prediction function
      async function runPrediction() {
        try {
          if (!uploadedImagePath) {
            showToast('Please upload an image first', 'error');
            return;
          }

          // Get selected density
          const densityRadio = document.querySelector('input[name="density"]:checked');
          const density = densityRadio ? densityRadio.value : 'low';

          showToast(`Starting ${density} density prediction...`, 'info');

          // Step 1: Get actual image dimensions
          const userId = currentUser?.id || 'unknown';
          const imageUrl = `${API_BASE_URL}/uploads/user_${userId}/${uploadedImagePath}`;
          
          // Load image to get actual dimensions
          const img = new Image();
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = imageUrl;
          });

          const imageWidth = img.width;
          const imageHeight = img.height;
          
          // Store dimensions globally for stats display
          uploadedImageDimensions = { width: imageWidth, height: imageHeight };
          
          console.log(`Image dimensions: ${imageWidth}x${imageHeight}`);
          showToast(`Image size: ${imageWidth}x${imageHeight}`, 'info');

          // Step 2: Generate coordinates based on actual image size
          const coords = generateCoordinates(density, imageWidth, imageHeight);
          const csvContent = coordinatesToCSV(coords);
          const coordsFilename = `coordinates_${density}_${Date.now()}.csv`;

          // Step 3: Upload coordinates CSV
          const coordsUpload = await api.uploadCoordinates(csvContent, coordsFilename);
          generatedCoordinatesFile = coordsUpload.filename;

          showToast(`Generated ${coords.length} prediction points`, 'success');

          // Step 4: Run prediction with selected genes
          const selectedGenesArray = Array.from(selectedGenes);
          const genesParam = selectedGenesArray.length > 0 ? selectedGenesArray.join(',') : 'all';
          
          showToast(`Running AI prediction for ${selectedGenesArray.length || 50} genes... This may take a moment`, 'info');
          
          const response = await api.predict(
            uploadedImagePath,
            generatedCoordinatesFile,
            selectedModel,  // Use user-selected model (original or trained)
            genesParam
          );

          predictionResults = response;
          
          // Store gene metadata and categories for later use
          if (response.gene_metadata) {
            geneMetadata = response.gene_metadata;
          }
          if (response.gene_categories) {
            geneCategories = response.gene_categories;
          }
          
          console.log('Prediction response:', response);
          console.log(`Predicted ${response.num_genes} genes: ${response.genes.join(', ')}`);
          
          showToast(`Prediction complete! ${response.num_genes} genes analyzed. Credits: ${response.remaining_credits}`, 'success');
          
          // Navigate to heatmap page and initialize it with the first gene
          showPage('heatmap');

        } catch (error) {
          console.error('Prediction error:', error);
          showToast(`Prediction failed: ${error.message}`, 'error');
        }
      }

      // Heatmap Functions
      let currentHeatmaps = {}; // Store heatmaps for each gene
      let currentOriginalImage = null;

      async function displayHeatmap(geneName) {
        try {
          // Use first available gene if none specified
          if (!geneName && predictionResults && predictionResults.genes && predictionResults.genes.length > 0) {
            geneName = predictionResults.genes[0];
          } else if (!geneName) {
            geneName = 'ABCC11'; // ultimate fallback
          }
          
          // Show loading
          document.getElementById('heatmap-loading').classList.remove('hidden');
          document.getElementById('heatmap-comparison').classList.add('hidden');

          // Get user ID from current user
          const userId = currentUser?.id || 'unknown';
          
          // User-specific paths (SECURE - only shows user's own files)
          const originalImagePath = `${API_BASE_URL}/uploads/user_${userId}/${uploadedImagePath}`;
          
          // Choose visualization type based on current tab
          let imagePrefix = 'heatmap';
          let viewType = 'Heatmap';
          
          if (currentTab === 'overlay') {
            imagePrefix = 'overlay';
            viewType = 'Overlay';
          } else if (currentTab === 'contour') {
            imagePrefix = 'contour';
            viewType = 'Contour';
          }
          
          const visualizationPath = `${API_BASE_URL}/uploads/user_${userId}/${imagePrefix}_${geneName}_${uploadedImagePath}`;
          
          console.log(`Loading ${currentTab} for ${geneName}: ${visualizationPath}`);
          
          // Update original image
          const originalImg = document.getElementById('original-image');
          originalImg.src = originalImagePath;
          currentOriginalImage = originalImagePath;
          
          // Update heatmap/overlay/contour image based on current tab
          const heatmapImg = document.getElementById('heatmap-image');
          heatmapImg.src = visualizationPath;
          
          // Update UI text based on current tab
          document.getElementById('heatmap-title').textContent = `${geneName} Expression ${viewType}`;
          document.getElementById('original-filename').textContent = uploadedImagePath || 'image.png';
          
          // Update all stats boxes robustly
          updateStatsBoxes(geneName);
          
          // Update gene selector to match
          const geneSelect = document.getElementById('heatmap-gene-select');
          if (geneSelect) {
            geneSelect.value = geneName;
          }
          
          // Display gene statistics if available
          if (predictionResults && predictionResults.gene_statistics && predictionResults.gene_statistics[geneName]) {
            const stats = predictionResults.gene_statistics[geneName];
            const statMin = document.getElementById('stat-min');
            const statMax = document.getElementById('stat-max');
            const statMean = document.getElementById('stat-mean');
            const statStd = document.getElementById('stat-std');
            
            if (statMin) statMin.textContent = stats.min.toFixed(3);
            if (statMax) statMax.textContent = stats.max.toFixed(3);
            if (statMean) statMean.textContent = stats.mean.toFixed(3);
            if (statStd) statStd.textContent = stats.std.toFixed(3);
          }
          
          // Store current visualization path
          currentHeatmaps[geneName] = visualizationPath;
          
          // Wait for image to load
          await new Promise((resolve) => {
            heatmapImg.onload = resolve;
            heatmapImg.onerror = () => {
              showToast(`Heatmap for ${geneName} not found. It may still be generating...`, 'warning');
              resolve();
            };
          });
          
          // Hide loading, show comparison
          document.getElementById('heatmap-loading').classList.add('hidden');
          document.getElementById('heatmap-comparison').classList.remove('hidden');
          
          showToast(`Displaying ${geneName} expression heatmap`, 'success');
        } catch (error) {
          console.error('Display heatmap error:', error);
          showToast(`Failed to load heatmap: ${error.message}`, 'error');
        }
      }

      function switchGene(geneName) {
        displayHeatmap(geneName);
      }

      // Tab switching between Heatmap and Overlay views
      let currentTab = 'heatmap';  // Default to heatmap view
      
      function switchTab(tabName) {
        currentTab = tabName;
        
        // Update tab button styles
        const heatmapTab = document.getElementById('tab-heatmap');
        const overlayTab = document.getElementById('tab-overlay');
        const contourTab = document.getElementById('tab-contour');
        
        const activeClass = 'px-6 py-3 font-semibold text-purple-600 border-b-2 border-purple-600 transition-smooth';
        const inactiveClass = 'px-6 py-3 font-semibold text-gray-500 border-b-2 border-transparent hover:text-purple-600 transition-smooth';
        
        // Reset all tabs to inactive
        heatmapTab.className = inactiveClass;
        overlayTab.className = inactiveClass;
        contourTab.className = inactiveClass;
        
        // Set active tab and update icon
        if (tabName === 'heatmap') {
          heatmapTab.className = activeClass;
          document.getElementById('viz-icon').className = 'fas fa-chart-area text-purple-600 mr-2';
        } else if (tabName === 'overlay') {
          overlayTab.className = activeClass;
          document.getElementById('viz-icon').className = 'fas fa-layer-group text-purple-600 mr-2';
        } else if (tabName === 'contour') {
          contourTab.className = activeClass;
          document.getElementById('viz-icon').className = 'fas fa-wave-square text-purple-600 mr-2';
        }
        
        // Reload the current gene with the new view type
        const currentGene = document.getElementById('heatmap-gene-select').value;
        displayHeatmap(currentGene);
        
        const viewNames = { 'heatmap': 'Heatmap', 'overlay': 'Overlay', 'contour': 'Contour' };
        showToast(`Switched to ${viewNames[tabName]} view`, 'info');
      }

      function downloadHeatmap() {
        const currentGene = document.getElementById('heatmap-gene-select').value;
        const heatmapImg = document.getElementById('heatmap-image');
        
        if (heatmapImg.src) {
          const link = document.createElement('a');
          link.href = heatmapImg.src;
          link.download = `heatmap_${currentGene}_${uploadedImagePath}`;
          link.click();
          showToast('Heatmap downloaded!', 'success');
        } else {
          showToast('No heatmap to download', 'error');
        }
      }

      // Initialize heatmap when page loads
      function initializeHeatmap() {
        if (uploadedImagePath) {
          // Use the first gene from prediction results, or default to ABCC11
          const firstGene = (predictionResults && predictionResults.genes && predictionResults.genes.length > 0) 
            ? predictionResults.genes[0] 
            : 'ABCC11';
          displayHeatmap(firstGene);
        }
      }

      // Make functions global
      window.showPage = showPage;
      window.logout = logout;
      window.showToast = showToast;
      window.refreshCredits = refreshCredits;
      window.showLoginForm = showLoginForm;
      window.showRegisterForm = showRegisterForm;
      window.toggleGene = toggleGene;
      window.clearPredictionFile = clearPredictionFile;
      window.startNewPrediction = startNewPrediction;
      window.runPrediction = runPrediction;
      window.switchGene = switchGene;
      window.switchTab = switchTab;
      window.downloadHeatmap = downloadHeatmap;
    </script>
  </body>
</html>
